<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>渋谷チェーン店 混雑スキャナー</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6939344704678951" crossorigin="anonymous"></script>

  <script>
    (g=>{
      var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",
      q="__ib__",m=document,b=window;
      b=b[c]||(b[c]={});
      var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,
      u=()=>h||(h=new Promise(async(f,n)=>{
        await (a=m.createElement("script"));
        e.set("libraries",[...r]+"");
        for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t.toLowerCase()),g[k]);
        e.set("callback",c+".maps."+q);
        a.src=`https://maps.${c}apis.com/maps/api/js?`+e;
        d[q]=f;
        a.onerror=()=>h=n(Error(p+" could not load."));
        m.head.append(a);
      }));
      d[l]?console.warn(p+" only loads once."):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))
    })({
      key: "AIzaSyAn2H3SjTQvIhNQ64VDcYKHXZS2LI6cXnc",
      v: "weekly"
    });
  </script>
</head>

<body class="bg-gray-900 text-white pb-24">

<header class="bg-gray-800 p-4 sticky top-0 z-50 border-b border-orange-500 flex justify-between items-center">
  <h1 class="text-xl font-black text-orange-500">SHIBUYA CHAIN SCAN</h1>
  <span id="status" class="text-xs bg-orange-500 text-black px-2 py-1 rounded">READY</span>
</header>

<main id="shop-list" class="p-4 space-y-4">
  <p class="text-center text-orange-400 animate-pulse">周辺チェーン店をスキャン中...</p>
</main>

<script>
  function estimateBusy(place) {
    const hour = new Date().getHours();
    const day = new Date().getDay();
    let busy = 30;
    const reviews = place.user_ratings_total || 0;
    if (reviews > 3000) busy += 25;
    else if (reviews > 1000) busy += 15;
    else if (reviews > 300) busy += 8;
    if (place.rating >= 4.0) busy += 10;
    if (hour >= 11 && hour <= 14) busy += 25;
    if (hour >= 18 && hour <= 21) busy += 30;
    if (day === 0 || day === 6) busy += 10;
    if (place.opening_hours && place.opening_hours.open_now === false) return 0;
    busy += Math.random() * 10 - 5;
    return Math.max(5, Math.min(Math.round(busy), 100));
  }

  // 広告HTMLを生成する関数：IDを整理しました
  function adHTML() {
    return `
      <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 my-4 text-center">
        <p class="text-[10px] text-gray-500 mb-2 text-left">スポンサーリンク</p>
        <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-6939344704678951"
          data-ad-slot="1111111111"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      </div>
    `;
  }

  async function initApp() {
    const { PlacesService } = await google.maps.importLibrary("places");
    const container = document.getElementById("shop-list");
    const statusEl = document.getElementById("status");

    const shibuya = { lat: 35.658034, lng: 139.701636 };
    const service = new PlacesService(document.createElement("div"));

    service.nearbySearch({
      location: shibuya,
      radius: 1200,
      keyword: "サイゼリヤ ガスト デニーズ ジョナサン ロイヤルホスト バーミヤン ココス 牛角 焼肉きんぐ 安楽亭 叙々苑 ワンカルビ",
      type: "restaurant"
    }, (results, status) => {

      if (status !== google.maps.places.PlacesServiceStatus.OK) {
        statusEl.innerText = "ERROR";
        container.innerHTML = `<p class="text-red-400 text-center">取得失敗</p>`;
        return;
      }

      container.innerHTML = "";
      statusEl.innerText = "ONLINE";

      results.filter(p => p.name).forEach((place, index) => {
          // 5店舗ごとに広告を挿入
          if (index > 0 && index % 5 === 0) {
            container.insertAdjacentHTML("beforeend", adHTML());
            try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) {}
          }

          const busy = estimateBusy(place);
          let color = "bg-green-500";
          if (busy > 80) color = "bg-red-500";
          else if (busy > 60) color = "bg-yellow-500";

          container.insertAdjacentHTML("beforeend", `
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg mb-4">
              <div class="flex justify-between">
                <h3 class="font-bold text-lg">${place.name}</h3>
                <span class="text-orange-400 font-mono">★ ${place.rating ?? "--"}</span>
              </div>
              <div class="mt-4">
                <div class="flex justify-between text-xs mb-1 font-mono">
                  <span class="${busy === 0 ? "text-red-400" : "text-green-400"}">
                    ${busy === 0 ? "● CLOSED" : "● OPEN"}
                  </span>
                  <span>BUSY: ${busy}%</span>
                </div>
                <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full ${color} transition-all duration-500" style="width:${busy}%"></div>
                </div>
              </div>
            </div>
          `);
        });
    });
  }

  initApp();
</script>

<footer class="p-8">
  <p class="text-xs text-gray-500 text-center">
    ※ 混雑度はGoogle公式情報ではなく、レビュー数・時間帯などから推定した目安です
  </p>
</footer>

</body>
</html>
